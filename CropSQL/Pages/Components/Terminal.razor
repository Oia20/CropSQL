@inject IJSRuntime JSRuntime
<div class="whole-drop">
    <button class="dropdown-butn" @onclick="ToggleDropdown">Prompt @termNum <span class="dropdown-icon">&#9660;</span></button>
    @if (isDropdownVisible)
    {
        <ul @onclick="ToggleDropdown">
            <li @onclick="@(async () => await ChangeStage(1))"><a>1. Create Farm</a></li>
            <li @onclick="@(async () => await ChangeStage(2))"><a>2. Use DB</a></li>
            <li @onclick="@(async () => await ChangeStage(3))"><a>3. Create Table</a></li>
            <li @onclick="@(async () => await ChangeStage(4))"><a>4. Alter Table</a></li>
        </ul>
    }
</div>
<div class="container123">
<div class="sidebar">
    <ul>
        <li @onclick="@(async () => await ChangeStage(1))"><a>1. Create Farm</a></li>
        <li @onclick="@(async () => await ChangeStage(2))"><a>2. Use DB</a></li>
        <li @onclick="@(async () => await ChangeStage(3))"><a>3. Create Table</a></li>
        <li @onclick="@(async () => await ChangeStage(4))"><a>4. Alter Table</a></li>
    </ul>
</div>
<div class="container1234">
<div class="terminal">
    <h2 class="">CropSQL Terminal</h2>

<div class="output" @ref="outputRef">
    @{
        // starting index for past terminal commands.
        int startIndex = Math.Max(0, terminalOutput.Count - 10);
    }
    @for (int i = startIndex; i < terminalOutput.Count; i++)
    {
        <div class="outText">@terminalOutput[i]</div>
    }
</div>
    <input type="text" @ref="inputRef" placeholder="Add Commands Here" @bind="currentInput" @onkeydown="HandleInput"/> 
    <button @onclick="ButtonClicked" class="exec-but" >Execute</button>
</div>
<div class="prompt">
    <h2>Prompt</h2>

    <p>@prompt[termNum - 1]</p>
    <h3>Example:</h3>
    <div class="exampleCode">
        @foreach (string lines in codeSample[termNum - 1])
        {
            <p class="code-line">@string.Join(" ", lines)</p>
        }
    </div>
    </div>
</div>

</div>
@code {
    private List<string> terminalOutput = new List<string>(["CropSQL> Hello! Enter commands below."]);
    private string currentInput = "";
    private List<string> prompt = new List<string>([
        "Let's start by creating your farm with 'CREATE DATABASE' followed by the name of our farm followed by a semi-colon don't forget the semi-colon, this is how sql knows where your command ends.",
        "We need to tell SQL which Database we are using, do this by saying 'USE' followed by our farm name.",
        "You need a table to store the crops in your field. Create a table with 'CREATE TABLE' followed by the table name, we will name ours 'crops' then open a parentheses '('inside of your table you can specify columns, and what datatype goes into them. This will make more sense later in the game, but for now, lets create a column named Crop with a data type of varchar(20) which is a word with a max of 20 characters. Then an Amount column which takes and int, and a Word column which also takes an int.",
        "Oops, it looks like we forgot to add a column for how much our Crops are worth! Not to worry, SQL gives us a command for that. 'ALTER TABLE tableName' followed by ADD columnName datatype"
        ]);
    private List<string[]> codeSample = new List<string[]>
    {
        new string[] { "CREATE DATABASE sqland;" },
        new string[] { "USE sqland;" },
        new string[] { "CREATE TABLE crops (", "crop varchar(20),", "amount int;", ");"},
        new string[] { "ALTER TABLE crops", "ADD worth int;" }
    };
    
    private bool completed = false;
    private int termNum = 1;
    private ElementReference outputRef;
    private ElementReference inputRef;
    bool isDropdownVisible = false;

    void ToggleDropdown()
    {
        isDropdownVisible = !isDropdownVisible;
    }
    private void ButtonClicked() {
        ExecuteCommand(currentInput);
        currentInput = ""; // Clear the input field
    }

    private async Task HandleInput(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            // Get the value of the input field using JavaScript interop
            currentInput = await JSRuntime.InvokeAsync<string>("getInputValue", inputRef);

            ExecuteCommand(currentInput);
            currentInput = ""; // Clear the input field
        }
    }

    private Task ChangeStage(int stepNum) {
        termNum = stepNum;
        return Task.CompletedTask;
    }

    private void ExecuteCommand(string command)
    {
        // Process command here
        terminalOutput.Add("CropSQL> " + command);
        string[] words = command.Split(' ');
        Console.WriteLine(command);
        Console.WriteLine(words);

        switch (termNum) {
            case 1:
                if ( words.Length > 0 && words[0] == "CREATE" && words[1] == "DATABASE" && words.Length == 3) {
                    string last = command[command.Length - 1].ToString();
                    if (last == ";") {
                        Console.WriteLine("CREATED");
                        terminalOutput.Add("Challenge passed, DB created.");
                        termNum++;
                    }
                }
                break;
            case 2:
                if ( words.Length > 0 && words[0] == "USE" && words.Length == 2) {
                    string last = command[command.Length - 1].ToString();
                    if (last == ";") {
                        Console.WriteLine("CREATED");
                        terminalOutput.Add("Challenge passed, Using DB");
                        termNum++;
                    }
                }
                break;
            case 3:
                if (words.Length > 0 && words[0] == "CREATE" && words[1] == "TABLE" && words[2] == "crops" || words[2] == "crops(" && command.Contains("crop") && command.Contains("varchar") && command.Contains("20") && command.Contains("amount int")) {
                    string last = command[command.Length - 1].ToString();
                    if (last == ";") {
                        terminalOutput.Add("Challenge passed, Table Created in DB");
                        termNum++;
                    }
                }
            break;
            case 4:

            break;
        }
        StateHasChanged();
    }
}
